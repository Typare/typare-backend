<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Typare – UI Test v1</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    button { margin: 6px 6px 6px 0; padding: 8px 12px; }
    .box { border: 1px solid #ddd; padding: 10px; margin-top: 10px; }
    .label { font-weight: bold; }
    .muted { color: #666; }
  </style>
</head>
<body>
  <h1>Typare – UI Test v1</h1>

  <div>
    <button id="listen">Ascolta (mock)</button>
    <button id="listenReal">Ascolta (reale)</button>
    <button id="punto">Punto</button>
    <button id="stop">Stop</button>
    <button id="continua">Continua</button>
    <button id="rileggi">Rileggi</button>
    <button id="delSentence">Cancella frase</button>
    <button id="delWord">Cancella parola</button> 
    <button id="replaceWord">Sostituisci parola</button> 
    <button id="synonym">Sinonimo</button>
   </div>

  <div class="box">
    <div class="label">Stato</div>
    <div id="state" class="muted">ASCOLTO</div>
  </div>

  <div class="box">
    <div class="label">Buffer (frase in corso)</div>
    <div id="buffer"></div>
  </div>

  <div class="box">
    <div class="label">Testo finale</div>
    <div id="final"></div>
  </div>

  <script>
    // Stato semplice lato UI (per test flusso)
    let state = 'ASCOLTO'; // ASCOLTO | REVISIONE
    let buffer = '';
    let finalText = '';

    const elState = document.getElementById('state');
    const elBuffer = document.getElementById('buffer');
    const elFinal = document.getElementById('final');

    function render() {
      elState.textContent = state;
      elBuffer.textContent = buffer;
      elFinal.textContent = finalText;
    }

    // Mock "Ascolta": chiede al backend una frase finta
    document.getElementById('listen').onclick = async () => {
      if (state !== 'ASCOLTO') return;
      const r = await fetch('/mock/transcribe');
      const j = await r.json();
      buffer += (buffer ? ' ' : '') + j.text;
      render();
    };

    // Punto: chiude il segmento
    document.getElementById('punto').onclick = () => {
      if (state !== 'ASCOLTO' || !buffer) return;
      finalText += (finalText ? ' ' : '') + buffer.trim() + '.';
      buffer = '';
      render();
    };

    // Stop: entra in revisione
    document.getElementById('stop').onclick = () => {
      state = 'REVISIONE';
      render();
    };

    // Continua: torna ad ascolto
    document.getElementById('continua').onclick = () => {
      state = 'ASCOLTO';
      render();
    };

    // Rileggi: per ora evidenzia (mock TTS)
    document.getElementById('rileggi').onclick = () => {
      alert(finalText || '(niente da rileggere)');
    };
    // Cancella ultima frase (dal testo finale)
    document.getElementById('delSentence').onclick = () => {
    if (!finalText) return;
    // rimuove l'ultima frase terminata da punto
    finalText = finalText.trim().replace(/[^.]+\.?$/, '').trim();
    render();
   };

    // Cancella ultima parola (dal buffer se c'è, altrimenti dal testo finale)
    document.getElementById('delWord').onclick = () => {
    if (buffer) {
    buffer = buffer.trim().replace(/\s*\S+$/, '');
  } else if (finalText) {
    finalText = finalText.trim().replace(/\s*\S+\.?$/, '');
  }
  render();
};
    // Sostituisci ultima parola
    document.getElementById('replaceWord').onclick = () => {
    const newWord = prompt('Nuova parola:');
    if (!newWord) return;

    if (buffer) {
    buffer = buffer.trim().replace(/\S+$/, newWord);
  } else if (finalText) {
    finalText = finalText.trim().replace(/\S+(\.?$)/, newWord + '$1');
  }
  render();
};
    // Sinonimo (mock)
document.getElementById('synonym').onclick = () => {
  const synonyms = {
    'ok': ['bene', 'perfetto'],
    'calmo': ['tranquillo', 'sereno'],
    'mare': ['oceano', 'acqua'],
    'test': ['prova', 'verifica']
  };

  const applySynonym = (text) => {
    const words = text.trim().split(/\s+/);
    const last = words[words.length - 1].replace(/\.$/, '');
    const list = synonyms[last.toLowerCase()];
    if (!list) {
      alert('Nessun sinonimo (mock)');
      return text;
    }
    const choice = list[0]; // primo per ora
    words[words.length - 1] = choice;
    return words.join(' ') + (text.endsWith('.') ? '.' : '');
  };

  if (buffer) {
    buffer = applySynonym(buffer);
  } else if (finalText) {
    finalText = applySynonym(finalText);
  }
  render();
};
  // Ascolta reale (wire test)
  document.getElementById('listenReal').onclick = async () => {
  const r = await fetch('/transcribe', {
    method: 'POST'
  });
  const j = await r.json();
  buffer += (buffer ? ' ' : '') + j.text;
  render();
};

  render();
  </script>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Typare – UI Test v1</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    button { margin: 6px 6px 6px 0; padding: 8px 12px; }
    .box { border: 1px solid #ddd; padding: 10px; margin-top: 10px; }
    .label { font-weight: bold; }
    .muted { color: #666; }
  </style>
</head>

<body>
  <h1>Typare – UI Test v1</h1>

  <div>
    <button id="listen">Ascolta (mock)</button>
    <button id="listenReal">Ascolta (reale)</button>
    <button id="punto">Punto</button>
    <button id="stop">Stop</button>
    <button id="continua">Continua</button>
    <button id="rileggi">Rileggi</button>
    <button id="delSentence">Cancella frase</button>
    <button id="delWord">Cancella parola</button>
    <button id="replaceWord">Sostituisci parola</button>
    <button id="synonym">Sinonimo</button>
  </div>

  <div class="box">
    <div class="label">Stato</div>
    <div id="state" class="muted">ASCOLTO</div>
  </div>

  <div class="box">
    <div class="label">Buffer (frase in corso)</div>
    <div id="buffer"></div>
  </div>

  <div class="box">
    <div class="label">Testo finale</div>
    <div id="final"></div>
  </div>

  <script>
    /* =====================
       Stato UI
    ===================== */
    let state = 'ASCOLTO';
    let buffer = '';
    let finalText = '';

    const elState = document.getElementById('state');
    const elBuffer = document.getElementById('buffer');
    const elFinal = document.getElementById('final');

    function render() {
      elState.textContent = state;
      elBuffer.textContent = buffer;
      elFinal.textContent = finalText;
    }

    /* =====================
       MOCK ASCOLTO
    ===================== */
    document.getElementById('listen').onclick = async () => {
      if (state !== 'ASCOLTO') return;
      const r = await fetch('/mock/transcribe');
      const j = await r.json();
      buffer += (buffer ? ' ' : '') + j.text;
      render();
    };

    /* =====================
       PUNTO
    ===================== */
    document.getElementById('punto').onclick = () => {
      if (!buffer) return;
      finalText += (finalText ? ' ' : '') + buffer.trim() + '.';
      buffer = '';
      render();
    };

    document.getElementById('stop').onclick = () => {
      state = 'REVISIONE';
      render();
    };

    document.getElementById('continua').onclick = () => {
      state = 'ASCOLTO';
      render();
    };

    document.getElementById('rileggi').onclick = () => {
      alert(finalText || '(niente da rileggere)');
    };

    document.getElementById('delSentence').onclick = () => {
      finalText = finalText.replace(/[^.]+\.?$/, '').trim();
      render();
    };

    document.getElementById('delWord').onclick = () => {
      if (buffer) {
        buffer = buffer.replace(/\s*\S+$/, '');
      } else {
        finalText = finalText.replace(/\s*\S+\.?$/, '');
      }
      render();
    };

    document.getElementById('replaceWord').onclick = () => {
      const newWord = prompt('Nuova parola:');
      if (!newWord) return;
      if (buffer) {
        buffer = buffer.replace(/\S+$/, newWord);
      } else {
        finalText = finalText.replace(/\S+(\.?$)/, newWord + '$1');
      }
      render();
    };

    document.getElementById('synonym').onclick = () => {
      alert('Sinonimi (mock)');
    };

    /* =====================
       ASCOLTA REALE (MICROFONO + WHISPER)
    ===================== */
    document.getElementById('listenReal').onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const recorder = new MediaRecorder(stream);
      let chunks = [];

      recorder.ondataavailable = e => chunks.push(e.data);

      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: chunks[0].type });
        const formData = new FormData();
        formData.append('file', blob, 'recording.webm');

        const r = await fetch('/transcribe/audio', {
          method: 'POST',
          body: formData
        });

        const j = await r.json();
        if (j.text) {
          buffer += (buffer ? ' ' : '') + j.text;
          render();
        }
      };

      recorder.start();
      setTimeout(() => recorder.stop(), 4000);
    };

    render();
  </script>
</body>
</html>
